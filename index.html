<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="css/index.css" />
    <link rel="stylesheet" href="vendor/css/font-awesome.min.css" />
    <script src="vendor/js/jquery.min.js"></script>
    <script src="vendor/js/jsrender.min.js"></script>
    <script src="vendor/js/d3.v7.min.js"></script>
  </head>
  <body>
    <nav>
      <div id="title">WikiHow - Step-by-step visualization</div>
      <a class="link" href="">Paper</a>
      <a class="link" href="">Contact</a>
      <form id="search-form">
        <input name="search" placeholder="Type something to search..." />
        <button type="submit">
          <i class="fa fa-search"></i>
        </buttom>
      </form>
    </nav>
    <main>
      <div id="left"></div>
      <svg id="line-canvas"></svg>
      <div id="right"></div>
    </main>
    <script id="card" type="text/x-jsrender">
      <div class="card">
        <div class="card-header">
          <div class="card-title">{{:title}}</div>
          <div class="card-id">
            <div>{{:id}}</div>
          </div>
        </div>
        <div class="card-tags">{{for tags}}
          <div class="card-tag-outer">
            <span class="card-tag">{{:name}}</span>
          </div>
        {{/for}}</div>
        <div class="card-body">
          <ol class="card-section-captions">{{for captions}}
            <li id="{{:elem_id}}">
              <a class="card-section-caption">
                <div class="card-section-caption-title">{{:caption}}</div>
                <div class="card-section-caption-anchor">
                  <span class="card-section-caption-anchor-circle"></span>
                </div>
              </a>
            </li>
          {{/for}}</ol>
        </div>
      </div>
    </script>
    <script>
      $(document).ready(function () {
        load_data(function (dataset) {
          let visualizer = new Visualizer();
          let curr_datapoint = null;

          function initialize() {
            curr_datapoint = dataset.sample_datapoint();
            visualizer.visualize(curr_datapoint, dataset);
          }

          initialize();
        });
      });

      function load_data(callback) {
        $.getJSON("data/category_list.json", function (category_list) {
          $.getJSON("data/preprocessed_step_goals.json", function (step_goals) {
            $.getJSON("data/preprocessed_step_predictions.json", function (step_predictions) {
              callback(new Dataset(category_list, step_goals, step_predictions));
            });
          });
        });
      }

      class Visualizer {
        constructor() {
          this.card_template = $.templates("#card");
          this.current_datapoint = null;
        }

        visualize(datapoint, dataset) {
          // Set the current datapoint
          this.current_datapoint = datapoint;

          // Get the data
          let data = dataset.get_card_data(datapoint);

          // Render the object onto the page
          $("#left").html(this.card_template.render(data));

          // Setup the callbacks
          data.captions.forEach((caption) => {
            let step_id = caption.step_id;
            if (step_id) {
              $(`#left-caption-${step_id}`).click(() => {
                this.visualize_step(step_id, dataset);
              });
            }
          });
        }

        visualize_step(step_id, dataset) {
          // Clear the right
          $("#right").html("");

          // Get all the predictions
          let predictions = dataset.step_predictions[`${step_id}`]["pred"];

          // For each
          predictions.forEach((prediction) => {
            let task_id = prediction[0];
            let datapoint = new Datapoint(task_id, null);
            let data = dataset.get_card_data(datapoint);
            $("#right").append(this.card_template.render(data));
          });
        }
      }

      class Dataset {
        constructor(category_list, step_goals, step_predictions) {
          this.category_list = category_list;
          this.step_goals = step_goals;
          this.step_predictions = step_predictions;
        }

        num_tasks() {
          return Object.keys(this.step_goals).length
        }

        sample_datapoint() {
          let id = Math.floor(Math.random() * this.num_tasks());
          return this.get_datapoint(Object.keys(this.step_goals)[id])
        }

        get_datapoint(i) {
          return new Datapoint(i, null);
        }

        get_card_data(datapoint) {
          let task = this.step_goals[datapoint.task_id];
          return {
            title: task["task"],
            id: datapoint.task_id,
            tags: task["category"].map((c) => {
              return {name: this.category_list[c]};
            }),
            captions: task["caption"].map((c) => {
              if (Number.isInteger(c)) {
                return {
                  caption: this.step_predictions[`${c}`]["name"],
                  step_id: c,
                  elem_id: `left-caption-${c}`,
                }
              } else {
                return {caption: c}
              }
            }),
          }
        }
      }

      class Datapoint {
        constructor(task_id, caption_id) {
          this.task_id = `${task_id}`;
          this.caption_id = caption_id;
        }
      }

      // let card_template = $.templates("#card");
      // let left_data = {
      //   title: "How to use a camera",
      //   id: "32",
      //   tags: [{name: "Photography"}, {name: "Outdoor activity"}],
      //   captions: [
      //     // {text: "Buy a camera"},
      //     {caption: "Go to amazon.com"},
      //     {caption: "Search for camera"},
      //     {caption: "Search for camera"},
      //     // {text: "Use a camera"},
      //     {caption: "Open the box containing the camera"},
      //     {caption: "Take out the camera"},
      //   ],
      // };
      // $("#left").html(card_template.render(left_data))
    </script>
  </body>
</html>
